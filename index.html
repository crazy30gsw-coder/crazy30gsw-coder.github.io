<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>最新記事</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif; margin: 24px; }
    h1 { font-size: 40px; margin: 0 0 16px; }
    .meta { color: #666; margin-bottom: 18px; }
    .card { border: 1px solid #eee; border-radius: 14px; padding: 14px 16px; margin: 12px 0; }
    a { color: #0b5fff; text-decoration: none; }
    a:hover { text-decoration: underline; }
    .empty { color:#999; padding: 12px 0; }
    .btn { display:inline-block; padding:10px 14px; border:1px solid #ddd; border-radius:12px; cursor:pointer; user-select:none; }
  </style>
</head>
<body>
  <h1>最新記事</h1>
  <div class="meta">
    <span id="status">読み込み中...</span>
    &nbsp;|&nbsp;
    <span class="btn" id="reload">再読み込み</span>
  </div>

  <div id="list"></div>

  <script>
    async function loadPosts() {
      const status = document.getElementById("status");
      const list = document.getElementById("list");
      list.innerHTML = "";
      status.textContent = "posts.json を取得中...";

      try {
        const res = await fetch("./posts.json?ts=" + Date.now(), { cache: "no-store" });
        if (!res.ok) throw new Error("HTTP " + res.status);
        const posts = await res.json();

        if (!Array.isArray(posts) || posts.length === 0) {
          status.textContent = "記事がまだありません（posts.json が空）";
          list.innerHTML = '<div class="empty">記事がありません</div>';
          return;
        }

        // 新しい順にソート（dateがあれば）
        posts.sort((a,b) => (new Date(b.date || 0)) - (new Date(a.date || 0)));

        status.textContent = `表示中: ${posts.length}件`;
        for (const p of posts) {
          const title = (p.title || "(no title)");
          const link = (p.link || "#");

          const div = document.createElement("div");
          div.className = "card";
          div.innerHTML = `
            <div style="font-weight:700; font-size:18px; line-height:1.35;">
              <a href="${link}">${escapeHtml(title)}</a>
            </div>
            <div style="color:#666; margin-top:6px; font-size:13px;">
              ${p.date ? new Date(p.date).toLocaleString("ja-JP") : ""}
            </div>
          `;
          list.appendChild(div);
        }
      } catch (e) {
        status.textContent = "読み込み失敗: " + e.message;
        list.innerHTML = '<div class="empty">posts.json が見つからないか、壊れています</div>';
      }
    }

    function escapeHtml(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#39;");
    }

    document.getElementById("reload").addEventListener("click", loadPosts);
    loadPosts();
  </script>
</body>
</html>
