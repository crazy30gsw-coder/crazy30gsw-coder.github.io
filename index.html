<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>⚡ ボートレース速報まとめ</title>
<style>
  body { margin:0; font-family: system-ui, -apple-system, sans-serif; background:#fff; color:#111; }
  header { position:sticky; top:0; background:#fff; border-bottom:1px solid #ddd; padding:12px 14px; z-index:10; }
  header h1 { margin:0; font-size:20px; display:flex; gap:10px; align-items:center; }
  .badge { background:#ff8a00; color:#000; font-weight:800; padding:6px 10px; border-radius:10px; }
  main { padding:10px; max-width: 900px; margin:0 auto; }

  .topbar { display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin:10px 0 12px; }
  .pill { border:1px solid #ddd; padding:8px 10px; border-radius:999px; font-size:13px; background:#fff; }
  input { flex:1; min-width: 200px; padding:10px 12px; border-radius:999px; border:1px solid #ddd; font-size:14px; }

  .item { display:flex; gap:12px; padding:12px 6px; border-bottom:1px solid #eee; }
  .thumb { width:140px; height:80px; border-radius:10px; object-fit:cover; background:#f2f2f2; flex: 0 0 auto; }
  .title { font-size:16px; font-weight:800; line-height:1.3; margin:0; }
  .title a { color:#0b57d0; text-decoration:none; }
  .meta { margin-top:8px; display:flex; gap:10px; flex-wrap:wrap; font-size:12px; color:#666; }
  .src { background:#f4f4f4; border:1px solid #e6e6e6; padding:4px 8px; border-radius:999px; }
  .time { color:#444; }

  .small { color:#777; font-size:12px; margin: 8px 0 0; }

  @media (max-width: 420px){
    .thumb { width:120px; height:70px; }
    .title { font-size:15px; }
  }
</style>
</head>
<body>
<header>
  <h1><span class="badge">速</span> ボートレース速報まとめ</h1>
  <div class="small" id="status">更新: -</div>
</header>

<main>
  <div class="topbar">
    <input id="q" placeholder="検索（例：G1、芦屋、住之江、峰、事故…）">
    <button class="pill" id="reload">再読み込み</button>
    <span class="pill" id="count">表示: -</span>
  </div>

  <div id="list">読み込み中…</div>
</main>

<script>
const NOIMG = "./img/noimage.svg";
let ALL = [];

function fmt(d){
  const x = new Date(d);
  if (isNaN(x.getTime())) return "-";
  return x.toLocaleString();
}

function render(){
  const list = document.getElementById("list");
  const q = (document.getElementById("q").value || "").trim().toLowerCase();
  const filtered = ALL.filter(p => {
    if(!q) return true;
    return (p.title||"").toLowerCase().includes(q)
        || (p.source||"").toLowerCase().includes(q);
  });

  document.getElementById("count").textContent = `表示: ${filtered.length}件 / 全${ALL.length}件`;
  document.getElementById("status").textContent =
    `更新: ${ALL[0]?.published ? fmt(ALL[0].published) : "-"}`;

  if(filtered.length === 0){
    list.innerHTML = "該当なし";
    return;
  }

  list.innerHTML = filtered.map(p => {
    const img = (p.image && /^https?:\/\//i.test(p.image)) ? p.image : NOIMG;
    return `
      <div class="item">
        <img class="thumb" src="${img}" loading="lazy" onerror="this.src='${NOIMG}'">
        <div>
          <p class="title"><a href="${p.url}" target="_blank" rel="noopener">${p.title}</a></p>
          <div class="meta">
            <span class="src">${p.source || "RSS"}</span>
            <span class="time">${fmt(p.published)}</span>
          </div>
        </div>
      </div>
    `;
  }).join("");
}

async function load(){
  const list = document.getElementById("list");
  list.textContent = "読み込み中…";
  try{
    const r = await fetch("./posts.json?ts=" + Date.now());
    if(!r.ok) throw new Error("HTTP " + r.status);
    ALL = await r.json();
    render();
  }catch(e){
    list.textContent = "読み込み失敗: " + e.message;
  }
}

document.getElementById("q").addEventListener("input", render);
document.getElementById("reload").addEventListener("click", load);

load();
</script>
</body>
</html>